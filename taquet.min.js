/*! taquet.js - v0.0.1 - 2013-08-15 */!function(a){"use strict";"function"==typeof define&&define.amd?define(["_","$","Backbone","BubbleEvent"],function(b,c,Backbone,d){return a.call(this,b,c,Backbone,d)}):this.Taquet=a.call(this,this._,this.$,this.Backbone,this.BubbleEvent)}.call(this,function(a,b,Backbone,c){"use strict";function d(b,c){var e;try{if(c[1]._stopPropagation)return}catch(f){throw new Error("the event parameter is malformed")}e=b.shift(),e&&e.trigger.apply(e,c),b[0]&&a.defer(d,b,c)}function e(a){for(var b,c=[],d=a,e=null;"HTML"!==d.nodeName&&(d=d.parentNode);)if(e=d.getAttribute(n))for(b=e.match(/[^,\s]+/gi);e=b.shift();)t.hasOwnProperty(e)&&c.push(t[e]);return c}function f(a){var b,c,d,e,f=[],g=null,h=/[^,\s]+/g,i=[].push,j=[].slice;if(a){for(c=0,e=[a];d=e[c];)i.apply(e,j.call(d.children)),++c;for(;d=e[--c];)g=d.getAttribute(n),g&&(b=g.match(h))&&i.apply(f,b);return f}}function g(){return g.prototype._instance?g.prototype._instance:(g.prototype._instance=this,Object.hasOwnProperty("freeze")&&Object.freeze(g.prototype._instance),void 0)}function h(a){function b(a){return c[a]=c[a]||[],c[a]}if(h.prototype._commands=h.prototype._commands||{},h.prototype._commands[a])return h.prototype._commands[a];var c={};this.addCommand=function(a,c){b(a).push({scope:this,callback:c})},this.remove=function(a){if(this instanceof h)console.warn(a,"scope issue. Make sure to call exec with the right scope");else if(c&&"object"==typeof c[a])for(var b=0,d=c[a].length;d>b;b++)if(this===c[a][b].scope){c[a].splice(b,1);break}},this.exec=function(a){if(c[a])if(this instanceof h)console.warn(a,"scope issue. Make sure to call exec with the right scope");else for(var b,d=0,e=c[a].length,f=this instanceof h;e>d;d++)b=c[a][d],(f||!f&&this!==b.scope)&&b.callback.apply(b.scope,[{type:a,currentTarget:this}].concat([].slice.call(arguments,1)));else console.warn(a,"Nothing to trigger")},h.prototype._commands[a]=this,Object.hasOwnProperty("freeze")&&Object.freeze(h.prototype._commands[a])}function i(a){u.prototype[a]=function(){return[][a].apply(this,arguments)}}function j(){var a;if(this.el){if(a=this.el.getAttribute(n)){if(-1!==a.indexOf(this.cid))return;a+=", "+this.cid}else a=this.cid;this.el.setAttribute(n,a)}}function k(){var a,b=this.el.getAttribute(n);b=b.replace(new RegExp(",*[\\s]*"+this.cid+"[\\s]*,*","ig"),function(b){if(a=b.match(/,/g)){if(1===a.length)return 0===b.indexOf(",")?"":", ";if(2===a.length)return",";throw new Error("data-cid is corrupted")}return""}),this.el.setAttribute(n,b)}function l(a,b){return a&&(A.prototype.setElement.call(this,a,b),j.call(this)),this}var m,n="data-cid",o="TAQUET_NAVIGATE_EVENT",p=b(window),q=b(document);m={RESIZE_EVENT:"resize",HTML5:{canvas:!1,webgl:!1},$window:p,$document:q,proxy:function(a,b){if(arguments.length>2){var c=[].slice.call(arguments,2);return function(){return a.apply(b,[].slice.call(arguments).concat(c))}}return function(){return a.apply(b,[].slice.call(arguments))}}};var r=Backbone.History;Backbone.History=function(){console.log(">>> History instanciating!"),r.call(this)},Backbone.History.prototype=r.prototype;var s=Backbone.History.prototype.checkUrl;Backbone.History.prototype.checkUrl=function(){return console.log("checkUrl!",Backbone.history.getFragment()),s.call(Backbone.history)};var t={};g.prototype.add=function(a,b){t[a]=b},g.prototype.trigger=function(a){var b,c;"string"!=typeof a&&(b=[a.type,a].concat([].slice.call(arguments,1)),this.el&&this.el.parentNode&&(c=a.bubbleUp?e(this.el):f(this.el),d(c,b)))},g.prototype.remove=function(){var a,b,c;if(this.el&&this.el.firstChild&&(c=f(this.el)))for(b=new C;a=c.shift();)t.hasOwnProperty(a)&&(t[a].off(),t[a].remove(b))};var u;u=function(b){var c=this;v.apply(this),this.QUEUE_UPDATED="QUEUE_UPDATED_EVENT",a.each(b,function(a,b){c[b]=a}),this.proxy=m.proxy},u.hasOwnProperty("length")||(u.length=0),function(){var a=0,b=0,c=["push","pop","shift","unshift","slice","splice","join"];for(b=c.length;b>a;a++)i.call(this,c[a])}(),a.extend(u.prototype,{push:function(){return[].push.apply(this,arguments)},set:function(a){var b;for(this.clear();b=a.shift();)this.push(b);this.sendCommand(this.QUEUE_UPDATED)},clear:function(){do this.pop();while(this.length>0)},isEmpty:function(){return 0===this.length}});var v,w=null,x=a.uniqueId("singleton");v=function(b){b=b||{},w=new h(b.commandManagerId||this.commandManagerId||x),this.sendCommand=m.proxy(w.exec,this),this.removeCommand=w.remove,this.commands=this.commands||[],"string"==typeof this.commands&&(this.commands=[this.commands]),b.hasOwnProperty("commands")&&"function"==typeof this.commands.concat&&(this.commands=a.union(this.commands,b.commands));for(var c=0,d=this.commands.length;d>c;c++)"string"==typeof this.commands[c]&&w.addCommand.call(this,this.commands[c],this.commandHandler)};var y=Backbone.Model;Backbone.Model=function(a,b){return v.apply(this),y.call(this,a,b)},Backbone.Model.prototype=y.prototype,Backbone.Model.extend=y.extend;var z=Backbone.Collection;Backbone.Collection=function(a,b){return v.apply(this),z.call(this,a,b)},Backbone.Collection.prototype=z.prototype,Backbone.Collection.extend=z.extend;var A=Backbone.View,B=new g,C=function(){};Backbone.View=function(a){this.proxy=m.proxy,v.call(this,a),A.call(this,a),B.add(this.cid,this)},a.extend(Backbone.View.prototype,A.prototype,{setElement:function(a,b){return this.el instanceof HTMLElement&&a&&this.el!==a&&k.call(this),l.call(this,a,b)},render:function(){return this.el&&j.call(this),this},remove:function(a){if(this.commands)for(var b=0,c=this.commands.length;c>b;b++)this.removeCommand.call(this,this.commands[b]);a instanceof C||B.remove.call(this),A.prototype.remove.call(this)},trigger:function(a){var b=[a].concat([].slice.call(arguments,1));return"object"==typeof a&&a instanceof c?(B.trigger.apply(this,b),this):Backbone.Events.trigger.apply(this,b)},commandHandler:function(a){console.warn("commandHandler needs to be overriden. The following command was received, but ignored:",a)}},v.prototype),Backbone.View.extend=function(a,b){if(a.hasOwnProperty("render")){var c=a.render;a.render=function(){var a=c.call(this);return Backbone.View.prototype.render.call(this),a}}var d;return this.prototype.hasOwnProperty("commands")&&(d=this.prototype.commands),a.hasOwnProperty("commands")?[].unshift.apply(a.commands,d):a.commands=d,a.hasOwnProperty("stopListening")&&console.warn("stopListening() is not supposed to be overriden"),a.hasOwnProperty("remove")&&console.warn("remove() is not supposed to be overriden"),a.hasOwnProperty("setElement")&&console.warn("setElement() is not supposed to be overriden"),a.hasOwnProperty("stopListening")&&console.warn("stopListening() is not supposed to be overriden"),A.extend.call(this,a,b)};var D=function(b){b=b||{},b.commands=b.commands||[],b.commands.indexOf(o)<0&&b.commands.push(o),this.route=this.route||[],a.isArray(this.route)||(this.route=[this.route]),b.hasOwnProperty("route")&&(a.isArray(b.route)?[].push.apply(this.route,b.route):[].push.call(this.route,b.route)),Backbone.View.call(this,b)};a.extend(D.prototype,Backbone.View.prototype),D.prototype.initialize=function(){console.log("RoutedView initialized",this),this.hasOwnProperty("route")&&this.sendCommand(o,this.route)},D.prototype.commandHandler=function(a){switch(a.type){case o:var b=[].slice.call(arguments,1);if(b[0]===this)return console.log(">>>",b),this.show(b[1]),void 0}},D.prototype.show=function(){},D.prototype.hide=function(){},D.extend=function(a,b){return a.hasOwnProperty("initialize")&&console.log("initialize overwritten"),a.hasOwnProperty("route")&&console.log(a.route),Backbone.View.extend.call(this,a,b)};var E=Backbone.Router;Backbone.Router=function(a){return a=a||{},a.commands=a.commands||[],a.commands.indexOf(o)<0&&a.commands.push(o),v.call(this,a),E.call(this,a)},Backbone.Router.prototype=E.prototype,Backbone.Router.prototype.commandHandler=function(a){if(a)switch(a.type){case o:var b,c,d=[].slice.call(arguments[1]);for(b=0,c=d.length;c>b;b++)this.route(d[b],"animatedView",function(b){return function(){this.sendCommand(o,a.currentTarget,b)}}(d[b]))}},Backbone.Router.extend=function(a,b){if(a.hasOwnProperty("commandHandler")){var c=a.commandHandler;a.commandHandler=function(){return c.call(this,arguments)}}return E.extend.call(this,a,b)};var F=function(){v.apply(this),this.initialize.apply(this),this.$window.trigger(m.RESIZE_EVENT)};a.extend(F.prototype,m),a.extend(F.prototype,Backbone.Events),F.extend=Backbone.View.extend;var Taquet;return Taquet={CommandManager:h,RoutedView:D}});
/*
//@ sourceMappingURL=taquet.map.js
*/